<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Creating a Sails Application using Passport Authentication</title>
    <meta name="description" content="Sparktree - Devops posts & guides about interesting tech like Docker, Letsencrypt, Chef, Angular, Automation, API's or other topics that you should know about. " />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/favicon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/favicon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/favicon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/favicon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/favicon/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/favicon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/favicon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/favicon/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/assets/favicon/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="/assets/favicon/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="/assets/favicon/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="/assets/favicon/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="/assets/favicon/mstile-310x310.png" />


    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/github-repos.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/lightgallery.min.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/justifiedGallery.min.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
    <!-- Everything inside the #post tags pulls data from the page -->
<!-- #post -->
    <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />


    
    <!-- Twitter page metadata -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@analogj">
    <meta name="twitter:creator" content="@analogj">
    <meta name="twitter:title" content="Sparktree - Creating a Sails Application using Passport Authentication" />
    <meta name="twitter:description" content="Creating a Sails Application using Passport Authentication $ mkdir sails-passport-authentication $ sails new . $ sails generate user Populate the User model /api/models/User.js module.exports = {..." />
    <meta name="twitter:url" content="https://blog.thesparktree.com/creating-a-sails-application-using-passport" />
    <meta name="twitter:image" content="https://blog.thesparktree.com/assets/images/cover_sails.jpg" />

    <!-- Opengraph page metadata -->
    <meta property="og:site_name" content="Sparktree" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Sparktree - Creating a Sails Application using Passport Authentication" />
    <meta property="og:description" content="Creating a Sails Application using Passport Authentication $ mkdir sails-passport-authentication $ sails new . $ sails generate user Populate the User model /api/models/User.js module.exports = {..." />
    <meta property="og:url" content="https://blog.thesparktree.com/creating-a-sails-application-using-passport" />
    <meta property="og:image" content="https://blog.thesparktree.com/assets/images/cover_sails.jpg" />

    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Website",
        "publisher": "Sparktree",
        "url": "https://blog.thesparktree.com/creating-a-sails-application-using-passport",
        "image": "https://blog.thesparktree.com/assets/images/cover_sails.jpg",
        "description": "Creating a Sails Application using Passport Authentication $ mkdir sails-passport-authentication $ sails new . $ sails generate user Populate the User model /api/models/User.js module.exports = {..."
    }
    </script>

    

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Sparktree" href="/feed.xml" />
<!-- /post -->


    <meta name="google-site-verification" content="u9dNr8UKTVkH5x31v66leOs6mu10T2cm2RRbeYbOh4o" />
</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="javascript:void(0)" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-author " role="presentation"><a href="/author/analogj">Author</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>

    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/cover_sails.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/logo.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="javascript:void(0)"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-post">

        <header class="post-header">
            <h1 class="post-title">Creating a Sails Application using Passport Authentication</h1>
            <section class="post-meta">
            <!-- <a href=''>Jason Kulatunga</a> -->
            <time class="post-date" datetime="2014-02-20">20 Feb 2014</time>
                <!-- [[tags prefix=" on "]] -->
                 
                <span class="tags-wrapper">
                
                    
                       <a href='/tag/nodejs'>Nodejs</a>,
                    
                
                    
                       <a href='/tag/sailsjs'>Sailsjs</a>,
                    
                
                    
                       <a href='/tag/passportjs'>Passportjs</a>,
                    
                
                    
                       <a href='/tag/sails'>Sails</a>
                    
                
                </span>
                
            </section>
        </header>

        <section class="post-content">
            

            <h1 id="creating-a-sails-application-using-passport-authentication">Creating a Sails Application using Passport Authentication</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$ mkdir sails-passport-authentication</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$ sails new .</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$ sails generate user</code></p>
  </li>
  <li>
    <p>Populate the <code class="language-plaintext highlighter-rouge">User</code> model</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /api/models/User.js

 module.exports = {

   attributes: {
       firstName: {
           type: 'string'
       },
       lastName: {
           type: 'string'
       },
       email: {
           type: 'email'
       },
       provider: {
           type: 'string'
       },
       provider_id:{
       	  type: 'string'
       },
       password: {
           type: 'string'
       }
   }

 };
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create the <code class="language-plaintext highlighter-rouge">passport-local</code> login view</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /views/user/login.ejs

 &lt;form action="/user/login" method="post"&gt;
     &lt;div&gt;
         &lt;label&gt;Email:&lt;/label&gt;
         &lt;input type="text" name="email"&gt;&lt;br&gt;&lt;/div&gt;
     &lt;div&gt;
         &lt;label&gt;Password:&lt;/label&gt;
         &lt;input type="password" name="password"&gt;&lt;/div&gt;
     &lt;div&gt;
         &lt;input type="submit" value="Submit"&gt;&lt;/div&gt;
 &lt;/form&gt;
</code></pre></div>    </div>

    <p>At this point we could run <code class="language-plaintext highlighter-rouge">$ sails lift</code> and access the <code class="language-plaintext highlighter-rouge">passport-local</code> login page by visiting <a href="http://localhost:1337/user/login">http://localhost:1337/user/login</a></p>
  </li>
  <li>
    <p>Create a test user</p>

    <p>Visit <a href="http://localhost:1337/user/create?email=test@test.com&amp;password=12345">http://localhost:1337/user/create?email=test@test.com&amp;password=12345</a> in a browser to create a new user with a username of <code class="language-plaintext highlighter-rouge">test@test.com</code> and a password of <code class="language-plaintext highlighter-rouge">12345</code></p>
  </li>
</ol>

<h1 id="enabling-passport-with-local-authentication-requires-a-few-steps">Enabling <code class="language-plaintext highlighter-rouge">passport</code> with local authentication requires a few steps:</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$ npm install passport --save</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$ npm install passport-local --save</code></p>
  </li>
  <li>
    <p>Creating the passport middleware configuration file.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /config/passport.js

 var passport = require('passport'),
 LocalStrategy = require('passport-local').Strategy;

 passport.serializeUser(function(user, done) {
     done(null, user.id);
 });

 passport.deserializeUser(function(id, done) {
     User.findOneById(id).done(function (err, user) {
         done(err, user);
     });
 });

 passport.use(new LocalStrategy({
 		usernameField: 'email',
 		passwordField: 'password'
 		},
     function(email, password, done) {
     User.findOne({ email: email}).done(function(err, user) {
   		  if (err) { return done(err); }
   			if (!user) { return done(null, false, { message: 'Unknown user ' + email }); }
   			if (user.password != password) { return done(null, false, { message: 'Invalid password' }); }
   			return done(null, user);
   		});
   	}
 ));
</code></pre></div>    </div>
  </li>
  <li>
    <p>Register the required passport connect middleware</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /config/express.js

 var passport = require('passport');

 module.exports.express = {
     customMiddleware: function (app) {
         app.use(passport.initialize());
         app.use(passport.session());
     }
 };
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create the UserController actions</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /api/controllers/UserController.js

 var passport = require('passport');
 module.exports = {
     login: function (req,res)
     {
         res.view();
     },

     passport_local: function(req, res)
     {
         passport.authenticate('local', function(err, user, info)
         {
             if ((err) || (!user))
             {
                 res.redirect('/user/login');
                 return;
             }

             req.logIn(user, function(err)
             {
                 if (err)
                 {
                     res.redirect('/user/login');
                     return;
                 }

                 res.redirect('/');
                 return;
             });
         })(req, res);
     },

     logout: function (req,res)
     {
         req.logout();
         res.redirect('/');
     },



   /**
    * Overrides for the settings in `config/controllers.js`
    * (specific to UserController)
    */
   _config: {}


 };
</code></pre></div>    </div>
  </li>
  <li>
    <p>Modify routes to handle post to <code class="language-plaintext highlighter-rouge">/user/login</code>.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /config/routes.js

 module.exports.routes = {
     '/': {
         view: 'home/index'
     },
     'get /user/login':{
         controller: 'user',
         action: 'login'
     },
     'post /user/login':{
         controller: 'user',
         action: 'passport_local'
     }
 }
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create policy file
 This policy file will check that the user has been authenticated by <code class="language-plaintext highlighter-rouge">Passport</code> and if not it will redirect them to the login page.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /api/policies/isAuthenticated.js

 module.exports = function(req, res, next) {

     // User is allowed, proceed to the next policy,
     // or if this is the last policy, the controller
     // Sockets
     if(req.isSocket)
     {
         if(req.session &amp;&amp;
             req.session.passport &amp;&amp;
             req.session.passport.user)
         {
             //Use this:

             // Initialize Passport
             sails.config.passport.initialize()(req, res, function () {
                 // Use the built-in sessions
                 sails.config.passport.session()(req, res, function () {
                     // Make the user available throughout the frontend
                     //res.locals.user = req.user;
                     //the user should be deserialized by passport now;
                     next();
                 });
             });

             //Or this if you dont care about deserializing the user:
             //req.user = req.session.passport.user;
             //return next();

         }
         else{
             res.json(401);
         }


     }
     else if (req.isAuthenticated()) {
         return next();
     }
     else{
         // User is not allowed
         // (default res.forbidden() behavior can be overridden in `config/403.js`)
         return res.redirect('/account/login');
     }
 };
</code></pre></div>    </div>
  </li>
  <li>
    <p>Apply policy file
 The following configuration requires all requests to be authenticated. The only exception is requests to the user controller.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /config/policies.js

 module.exports.policies = {
     '*': 'isAuthenticated',
     'user': {
         '*': true
     }
 }
</code></pre></div>    </div>

    <p>Running <code class="language-plaintext highlighter-rouge">$ sails lift</code> and attempting to access any controller other than <code class="language-plaintext highlighter-rouge">user</code> will redirect you to the <code class="language-plaintext highlighter-rouge">/user/login</code>.</p>

    <p>Note:
 Policies only apply to controllers, not views. Which means that the root ‘/’ index view will still be accessible until you put it behind a controller. <a href="https://github.com/balderdashy/sails/issues/1132">https://github.com/balderdashy/sails/issues/1132</a></p>
  </li>
</ol>

<p>Now test your application by running <code class="language-plaintext highlighter-rouge">$ sails lift</code> then visiting <code class="language-plaintext highlighter-rouge">http://localhost:1337/user/login</code>.
Just login with the email and password for the user we created initially:</p>

<ul>
  <li>email: test@test.com</li>
  <li>password: 12345</li>
</ul>

<p>You should now be redirected to the homepage.</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/analogj" style="background-image: url(/assets/images/analogj.jpg)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/analogj">Jason Kulatunga</a></h4>
                
                
                    <p> Devops & Infrastructure guy @Gusto (ex-Adobe). I write about, and play with, all sorts of new tech. All opinions are my own.</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> San Francisco, CA</span> 
                    <span class="author-link icon-link"><a href="https://blog.thesparktree.com"> blog.thesparktree.com</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Creating a Sails Application using Passport Authentication&amp;url=https://blog.thesparktree.com/creating-a-sails-application-using-passport"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.thesparktree.com/creating-a-sails-application-using-passport"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://blog.thesparktree.com/creating-a-sails-application-using-passport"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Subscribe -->
            
            <!-- Begin MailChimp Signup Form -->
<section class="gh-subscribe">
    <h3 class="gh-subscribe-title">Subscribe to Sparktree</h3>
    <p>Get the latest posts delivered right to your inbox.</p>

    <form action="//thesparktree.us12.list-manage.com/subscribe/post?u=8600f4c40c69856634ec2a2c8&amp;id=db2fcf78fd" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div class="mc-field-group form-group">
            <input type="email" value="" name="EMAIL" class="subscribe-email required email" id="mce-EMAIL">
        </div>
        <button class="" type="submit">Subscribe</button>

        <input type="hidden" name="SIGNUP" value="/creating-a-sails-application-using-passport" id="mce-SIGNUP">
        <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
        </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8600f4c40c69856634ec2a2c8_db2fcf78fd" tabindex="-1" value=""></div>
    </form>


    <span class="gh-subscribe-rss">or subscribe <a href="http://cloud.feedly.com/#subscription/feed/https://blog.thesparktree.com/feed.xml">via RSS</a> with Feedly!</span>
</section>


<!--End mc_embed_signup-->
            
            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://blog.thesparktree.com/creating-a-sails-application-using-passport'; //'a unique URL for each page where Disqus is present'
        this.page.title = 'Creating a Sails Application using Passport Authentication';
    };

    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');

        s.src = '//sparktree.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/cover_code.jpg)" href="/api-design-best-practices-part-2">
            <section class="post">
                <h2>API Design Best Practices - Part 2</h2>
                <p>This is a follow up to my previous API design post ["API Design Best Practices"](http://blog.thesparktree.com/post/41988581166/api-design-best-practices)...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/cover_angularjs.png)" href="/angularjs-interceptors-globally-handle-401-and">
            <section class="post">
                <h2>AngularJS Interceptors - Globally handle 401 and other Error Messages</h2>
                <p>If you’ve built your slick new app using AngluarJS you’re probably using the common pattern...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Sparktree</a> &copy; 2024</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/github-repos.min.js"></script>
    <script type="text/javascript" src="/assets/js/lightgallery.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.justifiedGallery.min.js"></script>

    <script type="text/javascript" src="/assets/js/index.js"></script>


    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-33233417-3', 'auto');
        ga('send', 'pageview');

     </script>

     <!-- Sumo -->
    <script src="https://load.sumome.com/" data-sumo-site-id="94ea7fd31eeea5aeae29f85e1ab1c01e52c9cc1aaf11deefb55faf0f57bdf2b4" async="async"></script>

</body>
</html>
