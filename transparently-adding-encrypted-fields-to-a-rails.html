<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Transparently adding encrypted fields to a Rails app using Mongoid</title>
    <meta name="description" content="Sparktree - Devops posts & guides about interesting tech like Docker, Letsencrypt, Chef, Angular, Automation, API's or other topics that you should know about. " />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/favicon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/favicon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/favicon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/favicon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/favicon/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/favicon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/favicon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/favicon/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/assets/favicon/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/assets/favicon/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="/assets/favicon/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="/assets/favicon/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="/assets/favicon/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="/assets/favicon/mstile-310x310.png" />


    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/github-repos.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/lightgallery.min.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/justifiedGallery.min.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
    <!-- Everything inside the #post tags pulls data from the page -->
<!-- #post -->
    <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />


    
    <!-- Twitter page metadata -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@analogj">
    <meta name="twitter:creator" content="@analogj">
    <meta name="twitter:title" content="Sparktree - Transparently adding encrypted fields to a Rails app using Mongoid" />
    <meta name="twitter:description" content="As a software architect, you are in the business of designing new applications while balancing business requirements against future utility. Unfortunately design specifications are not as..." />
    <meta name="twitter:url" content="https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails" />
    <meta name="twitter:image" content="https://blog.thesparktree.com/assets/images/cover_rails.png" />

    <!-- Opengraph page metadata -->
    <meta property="og:site_name" content="Sparktree" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Sparktree - Transparently adding encrypted fields to a Rails app using Mongoid" />
    <meta property="og:description" content="As a software architect, you are in the business of designing new applications while balancing business requirements against future utility. Unfortunately design specifications are not as..." />
    <meta property="og:url" content="https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails" />
    <meta property="og:image" content="https://blog.thesparktree.com/assets/images/cover_rails.png" />

    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Website",
        "publisher": "Sparktree",
        "url": "https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails",
        "image": "https://blog.thesparktree.com/assets/images/cover_rails.png",
        "description": "As a software architect, you are in the business of designing new applications while balancing business requirements against future utility. Unfortunately design specifications are not as..."
    }
    </script>

    

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Sparktree" href="/feed.xml" />
<!-- /post -->


    <meta name="google-site-verification" content="u9dNr8UKTVkH5x31v66leOs6mu10T2cm2RRbeYbOh4o" />
</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="javascript:void(0)" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-author " role="presentation"><a href="/author/analogj">Author</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>

    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/cover_rails.png) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/logo.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="javascript:void(0)"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-post">

        <header class="post-header">
            <h1 class="post-title">Transparently adding encrypted fields to a Rails app using Mongoid</h1>
            <section class="post-meta">
            <!-- <a href=''>Jason Kulatunga</a> -->
            <time class="post-date" datetime="2013-12-09">09 Dec 2013</time>
                <!-- [[tags prefix=" on "]] -->
                 
                <span class="tags-wrapper">
                
                    
                       <a href='/tag/opensource'>Opensource</a>,
                    
                
                    
                       <a href='/tag/mongodb'>Mongodb</a>,
                    
                
                    
                       <a href='/tag/ruby'>Ruby</a>,
                    
                
                    
                       <a href='/tag/ruby on rails'>Ruby on rails</a>,
                    
                
                    
                       <a href='/tag/encryption'>Encryption</a>,
                    
                
                    
                       <a href='/tag/mongoid'>Mongoid</a>
                    
                
                </span>
                
            </section>
        </header>

        <section class="post-content">
            

            <p>As a software architect, you are in the business of designing new applications while balancing business requirements against future utility. Unfortunately design specifications are not as immutable as we dream they are, and sometimes significant changes must be made after the fact.</p>

<p>In the following guide I’ll be explaining how to safely add encrypted fields to a Ruby on Rails application using MongoDB.</p>

<h1 id="technology-stack">Technology Stack</h1>

<p>Before getting started you should note that this guide was written and tested to work with the following software, however that does not mean it won’t work with your configuration. YMMV.</p>

<ul>
  <li>Rails 3.2.11</li>
  <li>Ruby 1.9.3p392</li>
  <li>Mongoid</li>
</ul>

<h2 id="mongoid-encrypted-fields-v122">Mongoid-Encrypted-Fields (v1.2.2)</h2>
<p>We will be using the excellent <a href="https://github.com/KoanHealth/mongoid-encrypted-fields">mongoid-encrypted-fields</a> v1.2.2 gem by KoanHealth to transparently add support for encrypted storage types to Mongoid. <code class="language-plaintext highlighter-rouge">mongoid-encrypted-fields</code> can encrypt the following Mongoid types:</p>

<ul>
  <li>Date</li>
  <li>DateTime</li>
  <li>Hash</li>
  <li>String</li>
  <li>Time</li>
</ul>

<p>Add the following to your <code class="language-plaintext highlighter-rouge">Gemfile</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem 'mongoid-encrypted-fields', '~&gt; 1.2.x'
</code></pre></div></div>

<h2 id="symmetric-encryption-v310">Symmetric-Encryption (v3.1.0)</h2>

<p>While <code class="language-plaintext highlighter-rouge">mongoid-encrypted-fields</code> provides us with a way to transparently access our encrypted fields, it doesn’t actually do the encryption or decryption itself. The gem allows developers to use an encryption library of their choice, and provides an example implementation using the <a href="https://github.com/mdp/gibberish">gibberish</a> gem. I’m partial to the <a href="https://github.com/reidmorrison/symmetric-encryption">symmetric-encryption</a> library myself, and so that is what I’ll be using in the guide below.</p>

<p>Add the following to your <code class="language-plaintext highlighter-rouge">Gemfile</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem 'symmetric-encryption', '~&gt; 3.1.x'
</code></pre></div></div>

<h1 id="preparing-your-mongoid-models">Preparing your Mongoid models</h1>

<p>If you’re reading this guide, you’ve most likely already got a working app using Mongoid. Lets use the following model as a simple example of how your current <code class="language-plaintext highlighter-rouge">Customer</code> model might look before adding encryption</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Customer</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Timestamps</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="n">type</span><span class="ss">:String</span>
  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">type</span><span class="ss">:String</span>
  <span class="n">field</span> <span class="ss">:website</span><span class="p">,</span> <span class="n">type</span><span class="ss">:String</span>
  <span class="n">field</span> <span class="ss">:private_data</span><span class="p">,</span> <span class="n">type</span><span class="ss">:Hash</span>
<span class="k">end</span>
</code></pre></div></div>

<p>At some point you realize that (you forgot to/you have updated specifications that/management wants to) add encryption to the <code class="language-plaintext highlighter-rouge">private_data</code> field. Leveraging the <code class="language-plaintext highlighter-rouge">mongoid-encrypted-fields</code> documentation, all you need to do is change the model to the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'mongoid-encrypted-fields'</span>
<span class="k">class</span> <span class="nc">Customer</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Timestamps</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="n">type</span><span class="ss">:String</span>
  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">type</span><span class="ss">:String</span>
  <span class="n">field</span> <span class="ss">:website</span><span class="p">,</span> <span class="n">type</span><span class="ss">:String</span>
  <span class="n">field</span> <span class="ss">:private_data</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Mongoid</span><span class="o">::</span><span class="no">EncryptedHash</span>
<span class="k">end</span>
</code></pre></div></div>

<h1 id="initialize-mongoid-encrypted-fields-and-symmetric-encryption">Initialize mongoid-encrypted-fields and symmetric-encryption</h1>

<p>I won’t get into creating the <code class="language-plaintext highlighter-rouge">symmetric-encryption</code> gem configuration file, as you can follow the instructions in their <a href="https://github.com/reidmorrison/symmetric-encryption#rails-configuration">documentation</a></p>

<p>Assuming that the configuration is correct and located in the config folder you can use the following commands in your rails initializer to initialize both libraries correctly.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">SymmetricEncryption</span><span class="p">.</span><span class="nf">load!</span><span class="p">(</span><span class="s1">'config/symmetric-encryption.yml'</span><span class="p">,</span> <span class="s1">'production'</span><span class="p">)</span>
<span class="no">Mongoid</span><span class="o">::</span><span class="no">EncryptedFields</span><span class="p">.</span><span class="nf">cipher</span> <span class="o">=</span> <span class="no">SymmetricEncryption</span>
</code></pre></div></div>

<h1 id="migrate-previous-data">Migrate previous data</h1>

<p>At this point you’re probably thinking that while this is great and all, you already have data stored in your production database. Don’t worry, we’ll be migrating the existing data next.</p>

<p>The migration task can be done in a Rake task, or using the lovely <code class="language-plaintext highlighter-rouge">mongoid_migration</code> gem.</p>

<p>The thing to note about the steps below is that the <code class="language-plaintext highlighter-rouge">unset</code> and <code class="language-plaintext highlighter-rouge">rename</code> operations are handled by <code class="language-plaintext highlighter-rouge">mongoid</code> not the <code class="language-plaintext highlighter-rouge">mongoid-encrypted-fields</code> gem, and as such the encrypt and decrypt operations are not executed. The <code class="language-plaintext highlighter-rouge">migrate_encrypted_field</code> rake task will not permanently delete your unencrypted data, just rename it. It is reversible if something goes wrong.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake migrate_encrypted_field
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">task</span> <span class="ss">:migrate_encrypted_field</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
	<span class="c1"># Rename the current :private_data field for all customers to :unencrypted_private_data</span>
	<span class="nb">p</span> <span class="s2">"STEP1 - RENAME private_data to  unencrypted_private_data"</span>
	<span class="no">Customer</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
		<span class="nb">p</span> <span class="s2">"renaming the :private_data field for </span><span class="si">#{</span><span class="n">customer</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
		<span class="k">if</span> <span class="o">!</span> <span class="n">customer</span><span class="p">[</span><span class="ss">:unencrypted_private_data</span><span class="p">]</span>
		  <span class="n">customer</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="ss">:private_data</span><span class="p">,</span> <span class="ss">:unencrypted_private_data</span><span class="p">);</span>
		  <span class="n">customer</span><span class="p">.</span><span class="nf">unset</span><span class="p">(</span><span class="ss">:private_data</span><span class="p">)</span>
		  <span class="n">customer</span><span class="p">.</span><span class="nf">save!</span>
		<span class="k">else</span>
		  <span class="nb">p</span> <span class="s2">"unencrypted_private_data found already. skipping"</span>
		<span class="k">end</span>

	<span class="k">end</span>

	<span class="c1"># This step will do the actual data encryption and migration back to the :private_data field</span>
	<span class="nb">p</span> <span class="s2">"STEP2 - ENCRYPT AND SAVE"</span>
	<span class="no">Customer</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
	  <span class="nb">p</span> <span class="s2">"encrypting the data stored in the :unencrypted_private_data field as :private_data for </span><span class="si">#{</span><span class="n">customer</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
	  <span class="n">customer</span><span class="p">[</span><span class="ss">:private_data</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer</span><span class="p">[</span><span class="ss">:unencrypted_private_data</span><span class="p">];</span>
	  <span class="n">customer</span><span class="p">.</span><span class="nf">save!</span>
	<span class="k">end</span>

	<span class="c1"># This step will verify that the unencrypted data matches the decrypted data. It will not delete the `unencrypted_private_data` field</span>
	<span class="nb">p</span> <span class="s2">"STEP3 - VERIFY"</span>
	<span class="n">errored</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="no">Customer</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
	  <span class="nb">p</span> <span class="s2">"verifying the data stored in the :unencrypted_private_data field matches the encrypted data stored in :private_data for </span><span class="si">#{</span><span class="n">customer</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>

	  <span class="k">if</span> <span class="n">customer</span><span class="p">[</span><span class="ss">:unencrypted_private_data</span><span class="p">]</span>   <span class="c1">#make sure that a unencrypted_private_data exists.</span>

		<span class="k">unless</span> <span class="n">customer</span><span class="p">.</span><span class="nf">private_data</span> <span class="o">!=</span> <span class="n">customer</span><span class="p">[</span><span class="ss">:unencrypted_private_data</span><span class="p">]</span>
		  <span class="nb">p</span> <span class="s2">"!!ERROR!! the decrypted data does not match the unencrypted data for </span><span class="si">#{</span><span class="n">customer</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
		  <span class="n">errored</span><span class="p">.</span><span class="nf">push</span> <span class="n">credential</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span>
		<span class="k">end</span>
	  <span class="k">else</span>
		<span class="nb">p</span> <span class="s2">"unencrypted_private_data not found. Skipping"</span>
	  <span class="k">end</span>
	<span class="k">end</span>

	<span class="k">if</span> <span class="n">errored</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nb">p</span> <span class="s2">"The following customers produced errors while migrating, please verify manually"</span>
		<span class="nb">p</span> <span class="n">errored</span>
	<span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p>Once the rake task finishes it will automatically print out any <code class="language-plaintext highlighter-rouge">Customer</code> objects that require manual verification, (something that I never had any problems with). Once you have verified that everything is working correctly it’s time to remove the unneeded <code class="language-plaintext highlighter-rouge">unencrypted_private_data</code> field. Remember, this change cannot be undone.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake remove_unencrypted_field
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">task</span> <span class="ss">:remove_unencrypted_field</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
	<span class="c1"># Permanently remove unencrypted data</span>
	<span class="nb">p</span> <span class="s2">"STEP4 - PERMANENTLY REMOVE UNENCRYPTED DATA"</span>
	<span class="no">Customer</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
		<span class="nb">p</span> <span class="s2">"renaming the :private_data field for </span><span class="si">#{</span><span class="n">customer</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
		<span class="k">if</span> <span class="n">customer</span><span class="p">[</span><span class="ss">:unencrypted_private_data</span><span class="p">]</span>   <span class="c1">#make sure that a unencrypted_private_data exists.</span>
		  <span class="n">customer</span><span class="p">.</span><span class="nf">unset</span><span class="p">(</span><span class="ss">:unencrypted_test</span><span class="p">)</span>
		  <span class="n">customer</span><span class="p">.</span><span class="nf">save</span>

		<span class="k">else</span>
			<span class="nb">p</span> <span class="s2">"unencrypted_private_data not found. Skipping"</span>
		<span class="k">end</span>

	<span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If something did go wrong, you can always revert your migration using the following rake task</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake revert_encrypted_field
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">task</span> <span class="ss">:revert_encrypted_field</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
	<span class="no">Customer</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
		<span class="nb">p</span> <span class="s2">"reverting </span><span class="si">#{</span><span class="n">customer</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
		<span class="k">if</span> <span class="n">customer</span><span class="p">[</span><span class="ss">:unencrypted_private_data</span><span class="p">]</span>
			<span class="n">customer</span><span class="p">.</span><span class="nf">unset</span><span class="p">(</span><span class="ss">:private_data</span><span class="p">)</span>
			<span class="n">customer</span><span class="p">.</span><span class="nf">save!</span>
			<span class="n">customer</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="ss">:unencrypted_private_data</span><span class="p">,</span> <span class="ss">:private_data</span><span class="p">);</span>
			<span class="n">customer</span><span class="p">.</span><span class="nf">save!</span>
		<span class="k">else</span>
		<span class="nb">p</span> <span class="s2">"did nothing, unencrypted_private_data does not exist"</span>
		<span class="k">end</span>

	<span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h1 id="fin">Fin</h1>
<p>At this point you should have newly encrypted database field, with all your previous data migrated over. To access your encrypted data transparently, make sure your code is accessing the newly encrypted field as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Transparent (Decrypted) accessor</span>
<span class="n">customer</span><span class="p">.</span><span class="nf">private_data</span> <span class="c1"># =&gt; &lt;decrypted hash&gt;</span>

<span class="c1">#Encrypted string can be accessed as follows</span>
<span class="n">customer</span><span class="p">.</span><span class="nf">private_data</span><span class="p">.</span><span class="nf">encrypted</span> <span class="c1"># =&gt; &lt;encrypted string&gt;</span>

<span class="c1"># It can also be accessed using the hash syntax supported by Mongoid</span>
<span class="n">customer</span><span class="p">[</span><span class="ss">:private_data</span><span class="p">]</span> <span class="c1"># =&gt; &lt;encrypted string&gt;&lt;/encrypted&gt;&lt;/encrypted&gt;&lt;/decrypted&gt;</span>
</code></pre></div></div>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/analogj" style="background-image: url(/assets/images/analogj.jpg)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/analogj">Jason Kulatunga</a></h4>
                
                
                    <p> Devops & Infrastructure guy @Gusto (ex-Adobe). I write about, and play with, all sorts of new tech. All opinions are my own.</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> San Francisco, CA</span> 
                    <span class="author-link icon-link"><a href="https://blog.thesparktree.com"> blog.thesparktree.com</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Transparently adding encrypted fields to a Rails app using Mongoid&amp;url=https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Subscribe -->
            
            <!-- Begin MailChimp Signup Form -->
<section class="gh-subscribe">
    <h3 class="gh-subscribe-title">Subscribe to Sparktree</h3>
    <p>Get the latest posts delivered right to your inbox.</p>

    <form action="//thesparktree.us12.list-manage.com/subscribe/post?u=8600f4c40c69856634ec2a2c8&amp;id=db2fcf78fd" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div class="mc-field-group form-group">
            <input type="email" value="" name="EMAIL" class="subscribe-email required email" id="mce-EMAIL">
        </div>
        <button class="" type="submit">Subscribe</button>

        <input type="hidden" name="SIGNUP" value="/transparently-adding-encrypted-fields-to-a-rails" id="mce-SIGNUP">
        <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
        </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_8600f4c40c69856634ec2a2c8_db2fcf78fd" tabindex="-1" value=""></div>
    </form>


    <span class="gh-subscribe-rss">or subscribe <a href="http://cloud.feedly.com/#subscription/feed/https://blog.thesparktree.com/feed.xml">via RSS</a> with Feedly!</span>
</section>


<!--End mc_embed_signup-->
            
            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://blog.thesparktree.com/transparently-adding-encrypted-fields-to-a-rails'; //'a unique URL for each page where Disqus is present'
        this.page.title = 'Transparently adding encrypted fields to a Rails app using Mongoid';
    };

    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');

        s.src = '//sparktree.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/cover_angularjs.png)" href="/angularjs-media-queries-matchmedia-ng">
            <section class="post">
                <h2>AngularJS + Media Queries = matchmedia-ng</h2>
                <p>[matchmedia-ng](https://github.com/AnalogJ/matchmedia-ng) is a set of AngularJS bindings and helper functions for the matchMedia javascript api....</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/cover_angularjs.png)" href="/dropstore-ng-opensource-angularjs-bindings-for">
            <section class="post">
                <h2>dropstore-ng: opensource AngularJS bindings for Dropbox Javascript API</h2>
                <p>I created an github project called dropstore-ng that has angularjs bindings for the recently released...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Sparktree</a> &copy; 2024</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/github-repos.min.js"></script>
    <script type="text/javascript" src="/assets/js/lightgallery.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.justifiedGallery.min.js"></script>

    <script type="text/javascript" src="/assets/js/index.js"></script>


    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-33233417-3', 'auto');
        ga('send', 'pageview');

     </script>

     <!-- Sumo -->
    <script src="https://load.sumome.com/" data-sumo-site-id="94ea7fd31eeea5aeae29f85e1ab1c01e52c9cc1aaf11deefb55faf0f57bdf2b4" async="async"></script>

</body>
</html>
